generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  password         String
  name             String
  role             UserRole
  cedula           String?           @unique
  phone            String?
  telegramChatId   String?           // Chat ID de Telegram para notificaciones
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  children         Child[]
  withdrawalOrders WithdrawalOrder[]

  @@map("users")
}

model Child {
  id               String            @id @default(cuid())
  name             String
  grade            String
  school           String
  parentId         String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  parent           User              @relation(fields: [parentId], references: [id], onDelete: Cascade)
  withdrawalOrders WithdrawalOrder[]

  @@map("children")
}

model Picker {
  id                String          @id @default(cuid())
  name              String
  cedula            String          @unique
  phone             String
  relationship      String
  withdrawalOrderId String          @unique
  createdAt         DateTime        @default(now())
  codeExpiresAt     DateTime?
  isActive          Boolean         @default(true)
  temporaryPassword String?
  updatedAt         DateTime        @updatedAt
  encryptedCode     String?
  withdrawalOrder   WithdrawalOrder @relation(fields: [withdrawalOrderId], references: [id], onDelete: Cascade)

  @@map("pickers")
}

model WithdrawalOrder {
  id             String           @id @default(cuid())
  childId        String
  parentId       String
  status         WithdrawalStatus @default(PENDING)
  qrCode         String?
  withdrawalDate DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  picker         Picker?
  child          Child            @relation(fields: [childId], references: [id], onDelete: Cascade)
  parent         User             @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@map("withdrawal_orders")
}

enum UserRole {
  PARENT
  GUARDIAN
  ADMIN
  PICKER
}

enum WithdrawalStatus {
  PENDING
  VALIDATED
  COMPLETED
  CANCELLED
}
